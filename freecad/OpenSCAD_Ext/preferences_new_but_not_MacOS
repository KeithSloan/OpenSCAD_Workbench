import FreeCAD
import FreeCADGui
from PySide2 import QtCore, QtWidgets, QtUiTools


class OpenSCAD_Ext_Preferences(QtWidgets.QWidget):
    """Preferences page for OpenSCAD_Ext workbench."""

    def __init__(self):
        super().__init__()

        ui_path = ":/ui/OpenSCAD_Ext_Preferences.ui"
        loader = QtUiTools.QUiLoader()
        ui_file = QtCore.QFile(ui_path)

        if not ui_file.open(QtCore.QFile.ReadOnly):
            FreeCAD.Console.PrintError(f"‚ùå Failed to open UI file: {ui_path}\n")
            return

        self.form = loader.load(ui_file, self)
        ui_file.close()

        # Ensure form fills widget area
        layout = QtWidgets.QVBoxLayout(self)
        layout.addWidget(self.form)
        layout.setContentsMargins(0, 0, 0, 0)

    def apply(self):
        """Called by FreeCAD when user clicks Apply/OK."""
        prefs = FreeCAD.ParamGet("User parameter:BaseApp/Preferences/Mod/OpenSCAD_Ext")

        chk = self.form.findChild(QtWidgets.QCheckBox, "chkVerboseLogging")
        if chk:
            prefs.SetBool("VerboseLogging", chk.isChecked())


class OpenSCAD_Ext_PreferenceProvider:
    """Registers OpenSCAD_Ext preference page with FreeCAD."""

    def getPages(self):
        return [
            {
                "name": "OpenSCAD_Ext",
                "group": "OpenSCAD_Ext",
                "page": OpenSCAD_Ext_Preferences,
            }
        ]


def Load():
    FreeCADGui.addPreferencePageProvider(OpenSCAD_Ext_PreferenceProvider())

