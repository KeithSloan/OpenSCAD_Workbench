import re


def parse_scad_library(path):
    """
    Parse a SCAD library file and extract:
        - file metadata
        - module documentation blocks
        - module signatures
    """
    with open(path, "r", encoding="utf-8", errors="ignore") as f:
        lines = f.readlines()

    file_info = {
        "path": path,
        "name": "",
        "description": "",
        "includes": [],
        "modules": [],
    }

    current_doc = []
    in_doc = False

    for i, line in enumerate(lines):
        s = line.strip()

        # ------------------------------
        # File-level comments
        # ------------------------------
        if s.startswith("// LibFile:"):
            file_info["name"] = s.split(":", 1)[1].strip()

        elif s.startswith("// Includes:"):
            continue

        elif s.startswith("//   include"):
            file_info["includes"].append(s.replace("//", "").strip())

        elif s.startswith("// FileSummary:"):
            file_info["description"] = s.split(":", 1)[1].strip()

        # ------------------------------
        # Module documentation
        # ------------------------------
        if s.startswith("// Module:"):
            current_doc = [s]
            in_doc = True
            continue

        if in_doc:
            if s.startswith("module "):
                module = _parse_module_block(current_doc, s)
                file_info["modules"].append(module)
                in_doc = False
            else:
                current_doc.append(s)

    return file_info


def _parse_module_block(doc_lines, module_line):
    """
    Extract documentation fields + module signature
    """
    module = {
        "name": "",
        "signature": "",
        "synopsis": "",
        "usage": "",
        "description": "",
        "arguments": [],
    }

    for l in doc_lines:
        l = l.strip()

        if l.startswith("// Module:"):
            module["name"] = l.split(":", 1)[1].strip().replace("()", "")

        elif l.startswith("// Synopsis:"):
            module["synopsis"] = l.split(":", 1)[1].strip()

        elif l.startswith("// Usage:"):
            module["usage"] = ""

        elif l.startswith("// Description:"):
            module["description"] = l.split(":", 1)[1].strip()

        elif l.startswith("//   ") and "=" in l:
            module["arguments"].append(l.replace("//", "").strip())

    # Extract signature
    m = re.search(r"module\s+([A-Za-z0-9_]+)\s*\(([^)]*)\)", module_line)
    if m:
        module["signature"] = f"{m.group(1)}({m.group(2)})"

    return module

